generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "sqlite"
}

// アプリ全体の設定
model App {
  id               String  @id @default(cuid())
  name             String // アプリ名
  slug             String  @unique // URLの一部になるよ (例: /my-app)
  privacyPolicyUrl String? // プライバシーポリシーURL
  faviconImageUrl  String? // ファビコン画像URL
  copyrightNotice  String? // 権利者表記
  contactUrl       String? // お問い合わせ先

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  surveys Survey[]
}

// アンケート自体の設定
model Survey {
  id          String   @id @default(cuid())
  appId       String // アプリID
  app         App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  slug        String   @unique // URLの一部になるよ (例: /campaign-2025)
  title       String // アンケートのタイトル
  description String? // 説明文 (HTMLタグ含めてもいいかも)
  notes       String? // 注意事項 (フォームの下に表示)
  startAt     DateTime // 開始日時
  endAt       DateTime // 終了日時

  // 見た目のカスタマイズ
  themeColor  String  @default("#6c4034") // テーマカラー (CSS変数 `--accent-color` とかにする)
  headerImage String? // ヘッダー画像のURL (文字列のみ)
  bgImage     String? // 背景画像のURL (文字列のみ)

  // Webhook設定
  webhookUrl  String? // 回答登録時に通知を送信するWebhook URL

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions Question[]
  responses Response[]
}

// 質問項目
model Question {
  id       String @id @default(cuid())
  surveyId String
  survey   Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  type      String // RADIO, SELECT, TEXT, TEXTAREA, CHECKBOX, EMAIL (バリデーション用)
  label     String // 質問文
  order     Int // 並び順
  required  Boolean @default(false) // 必須項目かどうか
  maxLength Int? // 文字数制限！ (自由入力系で使う)

  // 選択肢がある場合の中身
  options String? // JSON文字列で保存 ["男性", "女性"] みたいな感じ

  answers Answer[]
}

// ユーザーからの回答（１回分）
model Response {
  id       String @id @default(cuid())
  surveyId String
  survey   Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  userId      String // これが auser_id だよ！
  submittedAt DateTime @default(now())

  answers Answer[]

  @@unique([surveyId, userId])
}

// 個別の質問への答え
model Answer {
  id         String   @id @default(cuid())
  responseId String
  response   Response @relation(fields: [responseId], references: [id], onDelete: Cascade)

  questionId String
  question   Question @relation(fields: [questionId], references: [id])

  value String // ユーザーが選んだり入力した値
}

// 管理画面用ユーザー
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  password      String?
  role          String    @default("USER") // "ADMIN", "USER"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  auditLogs     AuditLog[]
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // CREATE, UPDATE, DELETE, LOGIN
  resource  String   // SURVEY, USER, AUTH
  resourceId String?
  details   String?  // JSON string
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}
